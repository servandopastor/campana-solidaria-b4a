<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaña Solidaria B4A</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-3xl mx-auto space-y-8">
        <h1 id="campaña-solidaria-b4a" class="text-3xl font-bold text-center mb-8">Campaña Solidaria B4A</h1>

        <!-- Resumen -->
        <section class="bg-white p-4 rounded shadow">
            <h2 id="resumen" class="text-2xl font-semibold mb-4">Resumen</h2>
            <div class="space-y-2">
                <div class="flex justify-between">
                    <span class="font-medium">Productos Comprometidos:</span> 
                    <span id="porcentajeProductos" class="font-bold">0.0%</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">Familias Comprometidas:</span> 
                    <span id="porcentajeFamilias" class="font-bold">0.0%</span>
                </div>
            </div>
        </section>

        <!-- Almacén -->
        <section class="bg-white p-4 rounded shadow">
            <h2 id="almacén" class="text-2xl font-semibold mb-4">Almacén</h2>
            <div id="almacen" class="space-y-2"></div>
        </section>

        <!-- Carro -->
        <section class="bg-white p-4 rounded shadow">
            <h2 id="carro" class="text-2xl font-semibold mb-4">Carro</h2>
            <div id="carroItems" class="mb-6 space-y-2"></div>
            <div class="flex items-center space-x-4">
                <select id="selectFamilia" class="flex-grow p-2 border rounded">
                    <option value="">Selecciona Familia</option>
                </select>
                <button id="confirmarCooperacion" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">
                    Confirmar Cooperación
                </button>
            </div>
        </section>

        <!-- Bodega Solidaria -->
        <section class="bg-white p-4 rounded shadow">
            <h2 id="bodega-solidaria" class="text-2xl font-semibold mb-4">Bodega Solidaria</h2>
            <table id="bodegaSolidaria" class="w-full">
                <thead>
                    <tr>
                        <th class="text-left">Producto</th>
                        <th class="text-left">Cantidad</th>
                        <th class="text-left">Familia</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <!-- Familias Pendientes -->
        <section class="bg-white p-4 rounded shadow">
            <h2 id="familias-pendientes" class="text-2xl font-semibold mb-4">Familias Pendientes</h2>
            <div id="familiasPendientes" class="space-y-2"></div>
        </section>

        <!-- NUEVA SECCIÓN: Edición manual de registros -->
        <section class="bg-white p-4 rounded shadow">
            <h2 id="editar-registro" class="text-2xl font-semibold mb-4">Editar Registro Manualmente</h2>

            <div class="space-y-4">
                <div class="flex flex-col">
                    <label for="archivo" class="font-medium">Archivo a editar</label>
                    <select id="archivo" class="p-2 border rounded">
                        <option value="data/bodega.json">Bodega (bodega.json)</option>
                        <option value="data/productos.json">Productos (productos.json)</option>
                    </select>
                </div>

                <div class="flex flex-col">
                    <label for="registroId" class="font-medium">ID del Registro</label>
                    <input id="registroId" type="text" class="p-2 border rounded" placeholder="Ej. ID del producto o registro">
                </div>

                <div class="flex flex-col">
                    <label for="campo" class="font-medium">Campo a modificar</label>
                    <input id="campo" type="text" class="p-2 border rounded" placeholder="Ej. nombre, cantidad, familia">
                </div>

                <div class="flex flex-col">
                    <label for="nuevoValor" class="font-medium">Nuevo valor</label>
                    <input id="nuevoValor" type="text" class="p-2 border rounded" placeholder="Ej. Nuevo valor del campo">
                </div>

                <button id="guardarCambios" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                    Guardar Cambios
                </button>
            </div>
        </section>
    </div>

    <script>
        let productos = [];
        let familias = [];
        let carro = [];
        let bodega = [];

        async function loadData() {
            try {
                const [productosData, familiasData] = await Promise.all([
                    fetch('data/productos.json').then(res => res.json()),
                    fetch('data/familias.json').then(res => res.json())
                ]);

                productos = productosData;
                familias = familiasData;

                updateUI();  // Actualizar la interfaz
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Función para obtener el SHA de un archivo en GitHub
        async function getFileSHA(filePath) {
            const response = await fetch(`https://api.github.com/repos/servandopastor/campana-solidaria-b4a/contents/${filePath}`, {
                method: 'GET',
                headers: {
                    Authorization: `token ${GITHUB_TOKEN}`, // Asegúrate de reemplazar con tu token
                    Accept: 'application/vnd.github.v3+json'
                }
            });

            const data = await response.json();
            return data.sha;
        }

        // Función para actualizar un archivo en GitHub
        async function updateFileOnGitHub(filePath, content) {
            const sha = await getFileSHA(filePath);

            const updatedContent = btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2))));

            const response = await fetch(`https://api.github.com/repos/servandopastor/campana-solidaria-b4a/contents/${filePath}`, {
                method: 'PUT',
                headers: {
                    Authorization: `token ${GITHUB_TOKEN}`, // Asegúrate de reemplazar con tu token
                    Accept: 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Actualización de ${filePath}`,
                    content: updatedContent,
                    sha: sha
                })
            });

            if (response.ok) {
                console.log(`${filePath} actualizado exitosamente`);
            } else {
                console.error('Error al actualizar el archivo:', await response.json());
            }
        }

        // Actualizar el registro manualmente
        document.getElementById('guardarCambios').addEventListener('click', async () => {
            const archivo = document.getElementById('archivo').value;
            const registroId = document.getElementById('registroId').value;
            const campo = document.getElementById('campo').value;
            const nuevoValor = document.getElementById('nuevoValor').value;

            let contenido = (archivo.includes('bodega')) ? bodega : productos;  // Determinar qué archivo se va a modificar

            // Buscar el registro por ID
            let registro = contenido.find(item => item.id === registroId);

            if (registro) {
                registro[campo] = nuevoValor;  // Modificar el campo correspondiente

                // Actualizar el archivo en GitHub
                await updateFileOnGitHub(archivo, contenido);

                alert('Registro actualizado exitosamente.');
                updateUI();  // Actualizar la interfaz
            } else {
                alert('Registro no encontrado.');
            }
        });

        document.addEventListener('DOMContentLoaded', loadData);  // Cargar datos cuando el DOM esté listo
    </script>
</body>
</html>
