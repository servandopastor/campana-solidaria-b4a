<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaña Solidaria B4A</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-size: 14px; /* Reducción general del tamaño de la fuente */
        }
        @media (max-width: 640px) {
            body {
                font-size: 12px; /* Aún más pequeño para móviles */
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="max-w-3xl mx-auto space-y-6 p-4">
        <h1 id="campaña-solidaria-b4a" class="text-2xl font-bold text-center mb-6">Campaña Solidaria B4A</h1>

        <div class="section bg-white p-3 rounded shadow">
            <h2 id="resumen" class="text-xl font-semibold mb-3">Resumen</h2>
            <div class="space-y-2">
                <div class="flex justify-between">
                    <span class="font-medium">Productos Comprometidos:</span>
                    <span id="porcentajeProductos" class="font-bold">0.0%</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">Familias Comprometidas:</span>
                    <span id="porcentajeFamilias" class="font-bold">0.0%</span>
                </div>
            </div>
        </div>

        <div class="section bg-white p-3 rounded shadow">
            <h2 id="almacén" class="text-xl font-semibold mb-3">Almacén</h2>
            <div id="almacen" class="space-y-2"></div>
        </div>

        <div class="section bg-white p-3 rounded shadow">
            <h2 id="carro" class="text-xl font-semibold mb-3">Carro</h2>
            <div id="carroItems" class="mb-4 space-y-2"></div>
            <div class="flex items-center space-x-4">
                <select id="selectFamilia" class="border p-2 rounded text-sm">
                    <option value="">Selecciona Familia</option>
                </select>
                <button id="confirmarCooperacion" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">Confirmar Cooperación</button>
            </div>
        </div>

        <div class="section bg-white p-3 rounded shadow">
            <h2 id="bodega-solidaria" class="text-xl font-semibold mb-3">Bodega Solidaria</h2>
            <table class="w-full text-sm">
                <thead>
                    <tr>
                        <th class="text-left">Producto</th>
                        <th class="text-left">Cantidad</th>
                        <th class="text-left">Familia</th>
                    </tr>
                </thead>
                <tbody id="bodegaItems"></tbody>
            </table>
        </div>

        <div class="section bg-white p-3 rounded shadow">
            <h2 id="familias-pendientes" class="text-xl font-semibold mb-3">Familias Pendientes</h2>
            <div id="familiasPendientes" class="space-y-1 text-sm"></div>
        </div>
    </div>

     <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzAiiMDy2tPMI44Jd66y_osIbuz5gEnyNWICaBW-endQwUEbisVvWrVl1XtP4F-hmZkcg/exec';
        
        async function fetchData(action, params = {}) {
            try {
                const url = new URL(SCRIPT_URL);
                url.searchParams.append('action', action);
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                
                console.log('Fetching data from:', url.toString());
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Received data:', data);
                return data;
            } catch (error) {
                console.error("Error fetching data:", error);
                alert("Hubo un error al cargar los datos. Por favor, revisa la consola para más detalles.");
                return null;
            }
        }

        async function updateAlmacen() {
            const productos = await fetchData('getProductos');
            if (!productos) return;
            const almacen = document.getElementById('almacen');
            almacen.innerHTML = productos.slice(1).map(producto => `
                <div class="flex justify-between items-center text-sm">
                    <span>${producto[1]}</span>
                    <div>
                        <span>${producto[2]} ${producto[3]}</span>
                        <button onclick="modificarProducto('${producto[0]}', -1)" class="ml-2 px-2 py-1 bg-red-500 text-white rounded">-</button>
                        <button onclick="modificarProducto('${producto[0]}', 1)" class="ml-1 px-2 py-1 bg-green-500 text-white rounded">+</button>
                    </div>
                </div>
            `).join('');
        }

        async function updateFamilias() {
            const familias = await fetchData('getFamilias');
            if (!familias) return;
            const selectFamilia = document.getElementById('selectFamilia');
            selectFamilia.innerHTML = '<option value="">Selecciona Familia</option>' + 
                familias.slice(1).map(familia => `<option value="${familia[0]}">${familia[1]}</option>`).join('');
            
            const familiasPendientes = document.getElementById('familiasPendientes');
            familiasPendientes.innerHTML = familias.slice(1).map(familia => `<div>${familia[1]}</div>`).join('');
        }

        async function updateCarro() {
            const carro = await fetchData('getCarro');
            if (!carro) return;
            const carroItems = document.getElementById('carroItems');
            carroItems.innerHTML = carro.slice(1).map(item => `
                <div class="flex justify-between items-center text-sm">
                    <span>${item[1]}</span>
                    <div>
                        <span>${item[2]} ${item[3]}</span>
                        <button onclick="modificarCarro('${item[0]}', -1)" class="ml-2 px-2 py-1 bg-red-500 text-white rounded">-</button>
                        <button onclick="modificarCarro('${item[0]}', 1)" class="ml-1 px-2 py-1 bg-green-500 text-white rounded">+</button>
                    </div>
                </div>
            `).join('');
        }

        async function updateBodega() {
            const bodega = await fetchData('getBodega');
            if (!bodega) return;
            const bodegaItems = document.getElementById('bodegaItems');
            bodegaItems.innerHTML = bodega.slice(1).map(item => `
                <tr>
                    <td>${item[0]}</td>
                    <td>${item[1]} ${item[2]}</td>
                    <td>${item[3]}</td>
                </tr>
            `).join('');
        }

        async function confirmarCooperacion() {
            const familiaId = document.getElementById('selectFamilia').value;
            if (!familiaId) {
                alert('Por favor, selecciona una familia');
                return;
            }

            try {
                const result = await fetchData('confirmarCooperacion', { familiaId });
                if (result.success) {
                    await updateCarro();
                    await updateBodega();
                    await updateFamilias();
                    alert('Cooperación confirmada');
                } else {
                    alert('Hubo un error al confirmar la cooperación: ' + (result.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error("Error confirming cooperation:", error);
                alert("Hubo un error al confirmar la cooperación. Por favor, intenta de nuevo más tarde.");
            }
        }

        async function modificarProducto(id, cantidad) {
            try {
                const result = await fetchData('modificarProducto', { id, cantidad });
                if (result.success) {
                    await updateAlmacen();
                } else {
                    alert('Hubo un error al modificar el producto: ' + (result.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error("Error modifying product:", error);
                alert("Hubo un error al modificar el producto. Por favor, intenta de nuevo más tarde.");
            }
        }

        async function modificarCarro(id, cantidad) {
            try {
                const result = await fetchData('modificarCarro', { id, cantidad });
                if (result.success) {
                    await updateCarro();
                    await updateAlmacen(); // Actualizamos también el almacén ya que puede haber cambiado
                } else {
                    alert('Hubo un error al modificar el carro: ' + (result.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error("Error modifying cart:", error);
                alert("Hubo un error al modificar el carro. Por favor, intenta de nuevo más tarde.");
            }
        }

        async function initPage() {
            await updateAlmacen();
            await updateFamilias();
            await updateCarro();
            await updateBodega();

            document.getElementById('confirmarCooperacion').addEventListener('click', confirmarCooperacion);
        }

        window.onload = initPage;
    </script>
</body>
</html>
