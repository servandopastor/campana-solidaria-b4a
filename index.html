<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaña Solidaria B4A</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="max-w-3xl mx-auto space-y-8 p-4">
        <h1 id="campaña-solidaria-b4a" class="text-3xl font-bold text-center mb-8">Campaña Solidaria B4A</h1>

        <div class="section bg-white p-4 rounded shadow">
            <h2 id="resumen" class="text-2xl font-semibold mb-4">Resumen</h2>
            <div class="space-y-2">
                <div class="flex justify-between">
                    <span class="font-medium">Productos Comprometidos:</span>
                    <span id="porcentajeProductos" class="font-bold">0.0%</span>
                </div>
                <div class="flex justify-between">
                    <span class="font-medium">Familias Comprometidas:</span>
                    <span id="porcentajeFamilias" class="font-bold">0.0%</span>
                </div>
            </div>
        </div>

        <div class="section bg-white p-4 rounded shadow">
            <h2 id="almacén" class="text-2xl font-semibold mb-4">Almacén</h2>
            <div id="almacen" class="space-y-2"></div>
        </div>

        <div class="section bg-white p-4 rounded shadow">
            <h2 id="carro" class="text-2xl font-semibold mb-4">Carro</h2>
            <div id="carroItems" class="mb-6 space-y-2"></div>
            <div class="flex items-center space-x-4">
                <select id="selectFamilia" class="border p-2 rounded">
                    <option value="">Selecciona Familia</option>
                </select>
                <button id="confirmarCooperacion" class="bg-blue-500 text-white px-4 py-2 rounded">Confirmar Cooperación</button>
            </div>
        </div>

        <div class="section bg-white p-4 rounded shadow">
            <h2 id="bodega-solidaria" class="text-2xl font-semibold mb-4">Bodega Solidaria</h2>
            <table class="w-full">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Familia</th>
                    </tr>
                </thead>
                <tbody id="bodegaItems"></tbody>
            </table>
        </div>

        <div class="section bg-white p-4 rounded shadow">
            <h2 id="familias-pendientes" class="text-2xl font-semibold mb-4">Familias Pendientes</h2>
            <div id="familiasPendientes" class="space-y-2"></div>
        </div>
    </div>

    <script>
        // URL de tu Web App de Google Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwNWZKr3YG7QCzub93cG5y8xnKokRejE_Zu9YkDHMEkqf6Zptobhx-glZktJhUqvGiFfQ/exec';
        
        async function fetchData(action) {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=${action}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Error fetching data:", error);
                alert("Hubo un error al cargar los datos. Por favor, intenta de nuevo más tarde.");
                return null;
            }
        }
        // ID de tu hoja de Google Sheets
        const SHEET_ID = '1i0jSp0r1iH4qvBM3HcWJcfJlUI8WmSFmve3uWfKMepI';
        
        // Función para cargar datos de una pestaña específica
        async function fetchSheetData(sheetName) {
            const response = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheetName}`);
            const text = await response.text();
            const data = JSON.parse(text.substr(47).slice(0, -2));
            return data.table.rows.map(row => row.c.map(cell => cell ? cell.v : ''));
        }

        // Función para actualizar el almacén
        async function updateAlmacen() {
            const productos = await fetchSheetData('Productos');
            const almacen = document.getElementById('almacen');
            almacen.innerHTML = productos.map(producto => `
                <div class="flex justify-between items-center">
                    <span>${producto[1]}</span>
                    <span>${producto[2]} ${producto[3]}</span>
                </div>
            `).join('');
        }

        // Función para actualizar las familias
        async function updateFamilias() {
            const familias = await fetchSheetData('Familias');
            const selectFamilia = document.getElementById('selectFamilia');
            selectFamilia.innerHTML = '<option value="">Selecciona Familia</option>' + 
                familias.map(familia => `<option value="${familia[0]}">${familia[1]}</option>`).join('');
            
            const familiasPendientes = document.getElementById('familiasPendientes');
            familiasPendientes.innerHTML = familias.map(familia => `<div>${familia[1]}</div>`).join('');
        }

        // Función para actualizar el carro
        async function updateCarro() {
            const carro = await fetchSheetData('Carro');
            const carroItems = document.getElementById('carroItems');
            carroItems.innerHTML = carro.map(item => `
                <div class="flex justify-between items-center">
                    <span>${item[1]}</span>
                    <span>${item[2]} ${item[3]}</span>
                </div>
            `).join('');
        }

        // Función para actualizar la bodega
        async function updateBodega() {
            const bodega = await fetchSheetData('Bodega');
            const bodegaItems = document.getElementById('bodegaItems');
            bodegaItems.innerHTML = bodega.map(item => `
                <tr>
                    <td>${item[0]}</td>
                    <td>${item[1]} ${item[2]}</td>
                    <td>${item[3]}</td>
                </tr>
            `).join('');
        }

        // Función para confirmar cooperación
        async function confirmarCooperacion() {
            const familiaId = document.getElementById('selectFamilia').value;
            if (!familiaId) {
                alert('Por favor, selecciona una familia');
                return;
            }

            try {
                const response = await fetch(`${SCRIPT_URL}?action=confirmarCooperacion&familiaId=${familiaId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();

                if (result.success) {
                    await updateCarro();
                    await updateBodega();
                    await updateFamilias();
                    alert('Cooperación confirmada');
                } else {
                    alert('Hubo un error al confirmar la cooperación: ' + (result.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error("Error confirming cooperation:", error);
                alert("Hubo un error al confirmar la cooperación. Por favor, intenta de nuevo más tarde.");
            }
        }

        // Inicializar la página
        async function initPage() {
            await updateAlmacen();
            await updateFamilias();
            await updateCarro();
            await updateBodega();

            document.getElementById('confirmarCooperacion').addEventListener('click', confirmarCooperacion);
        }

        // Llamar a initPage cuando la página cargue
        window.onload = initPage;
    </script>
</body>
</html>
